<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Selecting Region of Interest | A Guide to an Image Processing Pipeline for Classification with Machine Learning</title>
  <meta name="description" content="Chapter 3 Selecting Region of Interest | A Guide to an Image Processing Pipeline for Classification with Machine Learning" />
  <meta name="generator" content="bookdown 0.38 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Selecting Region of Interest | A Guide to an Image Processing Pipeline for Classification with Machine Learning" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Selecting Region of Interest | A Guide to an Image Processing Pipeline for Classification with Machine Learning" />
  
  
  

<meta name="author" content="Henry Sun, Biniam Garomsa, Hector Ontiveros" />


<meta name="date" content="2024-04-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="rename-raw-images.html"/>
<link rel="next" href="classifying-image-attributes-with-via.html"/>
<script src="book_assets/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="book_assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="book_assets/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="book_assets/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="book_assets/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#about-this-book"><i class="fa fa-check"></i><b>1.1</b> About This Book</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#introduction-1"><i class="fa fa-check"></i><b>1.2</b> Introduction</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.3</b> How to Use This Book</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#data-pipeline-overview"><i class="fa fa-check"></i><b>1.4</b> Data Pipeline Overview</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="rename-raw-images.html"><a href="rename-raw-images.html"><i class="fa fa-check"></i><b>2</b> Rename Raw Images</a>
<ul>
<li class="chapter" data-level="2.1" data-path="rename-raw-images.html"><a href="rename-raw-images.html#google-drive-files"><i class="fa fa-check"></i><b>2.1</b> Google Drive Files</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="rename-raw-images.html"><a href="rename-raw-images.html#load-packages"><i class="fa fa-check"></i><b>2.1.1</b> Load Packages</a></li>
<li class="chapter" data-level="2.1.2" data-path="rename-raw-images.html"><a href="rename-raw-images.html#mount-google-drive"><i class="fa fa-check"></i><b>2.1.2</b> Mount Google Drive</a></li>
<li class="chapter" data-level="2.1.3" data-path="rename-raw-images.html"><a href="rename-raw-images.html#copying-files"><i class="fa fa-check"></i><b>2.1.3</b> Copying Files</a></li>
<li class="chapter" data-level="2.1.4" data-path="rename-raw-images.html"><a href="rename-raw-images.html#renaming-files"><i class="fa fa-check"></i><b>2.1.4</b> Renaming Files</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="rename-raw-images.html"><a href="rename-raw-images.html#local-files"><i class="fa fa-check"></i><b>2.2</b> Local Files</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="rename-raw-images.html"><a href="rename-raw-images.html#load-packages-1"><i class="fa fa-check"></i><b>2.2.1</b> Load Packages</a></li>
<li class="chapter" data-level="2.2.2" data-path="rename-raw-images.html"><a href="rename-raw-images.html#copying-files-1"><i class="fa fa-check"></i><b>2.2.2</b> Copying Files</a></li>
<li class="chapter" data-level="2.2.3" data-path="rename-raw-images.html"><a href="rename-raw-images.html#renaming-files-1"><i class="fa fa-check"></i><b>2.2.3</b> Renaming Files</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html"><i class="fa fa-check"></i><b>3</b> Selecting Region of Interest</a>
<ul>
<li class="chapter" data-level="3.1" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#using-the-script"><i class="fa fa-check"></i><b>3.1</b> Using the Script</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#import-packages"><i class="fa fa-check"></i><b>3.1.1</b> Import Packages</a></li>
<li class="chapter" data-level="3.1.2" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#set-folder-path"><i class="fa fa-check"></i><b>3.1.2</b> Set Folder Path</a></li>
<li class="chapter" data-level="3.1.3" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#drawing-rois"><i class="fa fa-check"></i><b>3.1.3</b> Drawing ROIs</a></li>
<li class="chapter" data-level="3.1.4" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#output"><i class="fa fa-check"></i><b>3.1.4</b> Output</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#roipoly-functionalities"><i class="fa fa-check"></i><b>3.2</b> RoiPoly Functionalities</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#imagefile-class"><i class="fa fa-check"></i><b>3.2.1</b> ImageFile Class</a></li>
<li class="chapter" data-level="3.2.2" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#first-roi-and-masking-function"><i class="fa fa-check"></i><b>3.2.2</b> First ROI and Masking Function</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="selecting-region-of-interest.html"><a href="selecting-region-of-interest.html#documentation"><i class="fa fa-check"></i><b>3.3</b> Documentation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="classifying-image-attributes-with-via.html"><a href="classifying-image-attributes-with-via.html"><i class="fa fa-check"></i><b>4</b> Classifying Image Attributes with VIA</a>
<ul>
<li class="chapter" data-level="4.1" data-path="classifying-image-attributes-with-via.html"><a href="classifying-image-attributes-with-via.html#creating-project"><i class="fa fa-check"></i><b>4.1</b> Creating Project</a></li>
<li class="chapter" data-level="4.2" data-path="classifying-image-attributes-with-via.html"><a href="classifying-image-attributes-with-via.html#creating-attributes"><i class="fa fa-check"></i><b>4.2</b> Creating Attributes</a></li>
<li class="chapter" data-level="4.3" data-path="classifying-image-attributes-with-via.html"><a href="classifying-image-attributes-with-via.html#classify-pixels"><i class="fa fa-check"></i><b>4.3</b> Classify Pixels</a></li>
<li class="chapter" data-level="4.4" data-path="classifying-image-attributes-with-via.html"><a href="classifying-image-attributes-with-via.html#for-hubbard-brook-users"><i class="fa fa-check"></i><b>4.4</b> For Hubbard Brook Users</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html"><i class="fa fa-check"></i><b>5</b> Random Forest Image Classification</a>
<ul>
<li class="chapter" data-level="5.1" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html#introduction-to-random-forest"><i class="fa fa-check"></i><b>5.1</b> Introduction to Random Forest</a></li>
<li class="chapter" data-level="5.2" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html#using-the-script-1"><i class="fa fa-check"></i><b>5.2</b> Using the Script</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html#data-preparation"><i class="fa fa-check"></i><b>5.2.1</b> Data Preparation</a></li>
<li class="chapter" data-level="5.2.2" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html#hyperparameter-tuning"><i class="fa fa-check"></i><b>5.2.2</b> Hyperparameter Tuning</a></li>
<li class="chapter" data-level="5.2.3" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html#training-random-forest-model"><i class="fa fa-check"></i><b>5.2.3</b> Training Random Forest Model</a></li>
<li class="chapter" data-level="5.2.4" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html#generating-reclassified-images"><i class="fa fa-check"></i><b>5.2.4</b> Generating Reclassified Images</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="random-forest-image-classification.html"><a href="random-forest-image-classification.html#future-improvements"><i class="fa fa-check"></i><b>5.3</b> Future Improvements</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A Guide to an Image Processing Pipeline for Classification with Machine Learning</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="selecting-region-of-interest" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Selecting Region of Interest<a href="selecting-region-of-interest.html#selecting-region-of-interest" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter provides an overview about the Python scripts used to create a polygonal region of interest and mask for images contained in folders.</p>
<p>A region of interest is often needed to eliminate irrelevant regions or sections of the image. In our case, we wanted to focus solely on stream water/ice rather than surrounding rocks or shrubbery (these could interfere with the machine learning step later).</p>
<p>Before beginning this section, ensure that all image files are properly named.</p>
<p><code>interactive_ROI_app.py</code> is the script used to create a region of interest and mask for images within a folder. Below is a visual aid concept map that outlines the steps within this process.</p>
<p><img src="imgs/ROI%20concept%20map.png" width="956" /></p>
<div id="using-the-script" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Using the Script<a href="selecting-region-of-interest.html#using-the-script" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section will explain the necessary elements and steps for you to follow while
using this script. For more information about how the script works, see <strong>Section 3.2</strong>; for more information about the functions within the script, see <strong>Section 3.3</strong>.</p>
<div id="import-packages" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Import Packages<a href="selecting-region-of-interest.html#import-packages" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before running the script, load in all necessary packages. While testing our script, we have found that the “<code>Qt5Agg</code>” backend works best for Windows system while the “<code>MacOSX</code>” backend works best for Apple. These backends allow us to work interactively with the python plotting library <code>matplotlib</code>. For more information, visit <code>matplotlib</code>’s official website.<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></p>
<p>During testing of the script, we found <em>PyCharm</em> to be the best IDE for running the script, because <em>vscode</em> didn’t support interactivity through <code>matplotlib</code>. Thus, we recommend using <em>PyCharm</em> to run this program.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="selecting-region-of-interest.html#cb13-1" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb13-2"><a href="selecting-region-of-interest.html#cb13-2" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb13-3"><a href="selecting-region-of-interest.html#cb13-3" tabindex="-1"></a><span class="im">import</span> os.path</span>
<span id="cb13-4"><a href="selecting-region-of-interest.html#cb13-4" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-5"><a href="selecting-region-of-interest.html#cb13-5" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb13-6"><a href="selecting-region-of-interest.html#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="selecting-region-of-interest.html#cb13-7" tabindex="-1"></a>mpl.use(<span class="st">&#39;Qt5Agg&#39;</span>)  <span class="co"># backend</span></span>
<span id="cb13-8"><a href="selecting-region-of-interest.html#cb13-8" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb13-9"><a href="selecting-region-of-interest.html#cb13-9" tabindex="-1"></a><span class="im">from</span> roipoly <span class="im">import</span> RoiPoly</span>
<span id="cb13-10"><a href="selecting-region-of-interest.html#cb13-10" tabindex="-1"></a><span class="im">import</span> glob2</span>
<span id="cb13-11"><a href="selecting-region-of-interest.html#cb13-11" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-12"><a href="selecting-region-of-interest.html#cb13-12" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-13"><a href="selecting-region-of-interest.html#cb13-13" tabindex="-1"></a><span class="im">from</span> matplotlib.widgets <span class="im">import</span> Button</span>
<span id="cb13-14"><a href="selecting-region-of-interest.html#cb13-14" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> OrderedDict</span>
<span id="cb13-15"><a href="selecting-region-of-interest.html#cb13-15" tabindex="-1"></a><span class="im">from</span> matplotlib.path <span class="im">import</span> Path <span class="im">as</span> MplPath</span></code></pre></div>
</div>
<div id="set-folder-path" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Set Folder Path<a href="selecting-region-of-interest.html#set-folder-path" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our script denotes the file path to a folder and stores it in a variable <code>folder_path</code>. Change the example path to the path of the folder for which to operate on. We then use the <code>.glob</code> function of the <code>glob</code> package to store the file path for each image into the variable <code>image_folder</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="selecting-region-of-interest.html#cb14-1" tabindex="-1"></a>folder_path <span class="op">=</span> <span class="vs">r&quot;\Example\Path\To\Folder&quot;</span></span>
<span id="cb14-2"><a href="selecting-region-of-interest.html#cb14-2" tabindex="-1"></a>image_folder <span class="op">=</span> glob2.glob(folder_path <span class="op">+</span> <span class="st">&quot;/*&quot;</span>)</span></code></pre></div>
</div>
<div id="drawing-rois" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Drawing ROIs<a href="selecting-region-of-interest.html#drawing-rois" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After setting the folder path, <strong>run</strong> the script to open a popup window – this is the <code>matplotlib</code> interactive interface. It should display the first image in <code>image_folder</code> and give you the option to select an ROI.</p>
<p><img src="imgs/mid_creation_first_roi.png" width="960" /></p>
<p>In the <code>matplotlib</code> interactive interface, a point is drawn by left-clicking. By left-clicking again, a new point is created and the line becomes static. A new line is again shown from the last point to the user cursor.</p>
<p>To complete a figure, the user right- or double-clicks, bounding the last selected point to the first. The polygon created within the image is the region of interest (ROI).</p>
<p>Once you have finished drawing your ROI, click the <code>Confirm</code> button to apply the ROI and mask to all remaining images in the folder.</p>
<p><img src="imgs/confirmbutton.png" width="1440" /></p>
<p>After the mask has been applied, you can view the mask overlaid on all the remaining images (or prior images) by clicking the <code>Previous</code> or <code>Next</code> buttons.</p>
<p><img src="imgs/previousnext.jpg" width="1440" /></p>
<p>In some cases, the original ROI may no longer fit the new image - this is often the case if, for instance, snow melts and the water levels of the river rise. In such cases, redrawing the ROI may be necessary. To do this, click the <code>Restart masking</code> button, which should again bring up the interactive interface and allow you to redraw and confirm an ROI.</p>
<p><img src="imgs/restartmasking.png" width="1440" /></p>
<p>Once you are satisfied with your new ROI, click the <code>Confirm</code> button to apply the new mask to the remainder of the images in the folder, and keep scrolling with the <code>Previous</code> and <code>Next</code> buttons. Then, click <code>Finish masking</code> when you are done.</p>
<p><img src="imgs/finishmasking.jpg" width="1440" /></p>
<p>This will close the ROI window and generate data frames containing information about the masked images, as well as a folder containing the masked images.</p>
</div>
<div id="output" class="section level3 hasAnchor" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> Output<a href="selecting-region-of-interest.html#output" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After you are done drawing ROIs, the script will generate three seperate outputs automatically. See the photos below for examples.</p>
<p>The first is a wateryear folder containing masked images.</p>
<p><img src="imgs/wateryear_example_folder.png" width="960" /></p>
<p>The second is a dataframe that stores each <code>mask_id</code> to its associated mask.</p>
<p><img src="imgs/maskid_mask.png" width="744" /></p>
<p>Finally, the script will generate a dataframe that stores each <code>mask_id</code> to its associated date.</p>
<p><img src="imgs/date_mask_csv_example.png" width="704" /></p>
</div>
</div>
<div id="roipoly-functionalities" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> RoiPoly Functionalities<a href="selecting-region-of-interest.html#roipoly-functionalities" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><code>RoiPoly</code><a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> is the python module from which our mouse click events are handled. The functions within this script allow the user to create an ROI by drawing a polygon with mouse clicks. The following section will provide a descriptive overview of the script and its functions.</p>
<div id="imagefile-class" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> ImageFile Class<a href="selecting-region-of-interest.html#imagefile-class" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The script contains a class named <code>ImageFile</code>. Objects in this class have information
from a file along a specific filepath as their attributes.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="selecting-region-of-interest.html#cb15-1" tabindex="-1"></a><span class="kw">class</span> ImageFile:</span>
<span id="cb15-2"><a href="selecting-region-of-interest.html#cb15-2" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot; Image File class to save file path, file name, date, mask_id&quot;&quot;&quot;</span></span>
<span id="cb15-3"><a href="selecting-region-of-interest.html#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="selecting-region-of-interest.html#cb15-4" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, filename):</span>
<span id="cb15-5"><a href="selecting-region-of-interest.html#cb15-5" tabindex="-1"></a>        <span class="va">self</span>.path <span class="op">=</span> filename</span>
<span id="cb15-6"><a href="selecting-region-of-interest.html#cb15-6" tabindex="-1"></a>        <span class="va">self</span>.image_name <span class="op">=</span> filename.split(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb15-7"><a href="selecting-region-of-interest.html#cb15-7" tabindex="-1"></a>        <span class="va">self</span>.date <span class="op">=</span> <span class="va">self</span>.get_date()</span>
<span id="cb15-8"><a href="selecting-region-of-interest.html#cb15-8" tabindex="-1"></a>        <span class="va">self</span>.mm, <span class="va">self</span>.dd, <span class="va">self</span>.yy <span class="op">=</span> <span class="va">self</span>.date.split(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb15-9"><a href="selecting-region-of-interest.html#cb15-9" tabindex="-1"></a>        <span class="va">self</span>.mask_id <span class="op">=</span> <span class="va">None</span></span></code></pre></div>
<p>There is an <code>ImageFile</code> object for each image in the folder <code>image_folder</code>. Within this class are functions that extract the time stamp and an array of RGB values for each image. Additionally, the water year for each image is derived from its timestamp, as is a sliced-array version of each image for faster plotting. These objects are appended to image_file_list, which is then sorted by water years.</p>
<p>A list with complete information of every file in image_folder is appended to <code>image_file_list</code>, which is then sorted and converted to a list of arrays for plotting purposes.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="selecting-region-of-interest.html#cb16-1" tabindex="-1"></a>image_file_list <span class="op">=</span> []</span>
<span id="cb16-2"><a href="selecting-region-of-interest.html#cb16-2" tabindex="-1"></a><span class="cf">for</span> filename <span class="kw">in</span> image_folder:</span>
<span id="cb16-3"><a href="selecting-region-of-interest.html#cb16-3" tabindex="-1"></a>    filetype <span class="op">=</span> filename[<span class="op">-</span><span class="dv">4</span>:]</span>
<span id="cb16-4"><a href="selecting-region-of-interest.html#cb16-4" tabindex="-1"></a>    <span class="co"># Check if the file name ends with &quot;.JPG&quot; or &quot;.jpg&quot;</span></span>
<span id="cb16-5"><a href="selecting-region-of-interest.html#cb16-5" tabindex="-1"></a>    <span class="cf">if</span> filetype.lower() <span class="op">!=</span> <span class="st">&quot;.jpg&quot;</span>:</span>
<span id="cb16-6"><a href="selecting-region-of-interest.html#cb16-6" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb16-7"><a href="selecting-region-of-interest.html#cb16-7" tabindex="-1"></a>    curr_IF <span class="op">=</span> ImageFile(filename)</span>
<span id="cb16-8"><a href="selecting-region-of-interest.html#cb16-8" tabindex="-1"></a>    image_file_list.append(curr_IF)</span>
<span id="cb16-9"><a href="selecting-region-of-interest.html#cb16-9" tabindex="-1"></a></span>
<span id="cb16-10"><a href="selecting-region-of-interest.html#cb16-10" tabindex="-1"></a><span class="co"># sort by year, then month, then day</span></span>
<span id="cb16-11"><a href="selecting-region-of-interest.html#cb16-11" tabindex="-1"></a>image_file_list <span class="op">=</span> np.array(<span class="bu">sorted</span>(image_file_list, key<span class="op">=</span><span class="kw">lambda</span> x: (x.yy, x.mm, x.dd)))</span></code></pre></div>
</div>
<div id="first-roi-and-masking-function" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> First ROI and Masking Function<a href="selecting-region-of-interest.html#first-roi-and-masking-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Upon running the script, a popup window will open displaying the first image in <code>image_folder</code>. The user can then select a polygonal ROI and apply a mask.</p>
<p>Each selected point in a created polygon is stored into <code>poly_verts</code> (short for polygon vertices), which is used to create the mask outline for the region of interest.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="selecting-region-of-interest.html#cb17-1" tabindex="-1"></a><span class="kw">def</span> get_mask_poly_verts(image, poly_verts, on_original<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb17-2"><a href="selecting-region-of-interest.html#cb17-2" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(np.shape(image)) <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb17-3"><a href="selecting-region-of-interest.html#cb17-3" tabindex="-1"></a>        ny, nx, nz <span class="op">=</span> np.shape(image)</span>
<span id="cb17-4"><a href="selecting-region-of-interest.html#cb17-4" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-5"><a href="selecting-region-of-interest.html#cb17-5" tabindex="-1"></a>        ny, nx <span class="op">=</span> np.shape(image)</span>
<span id="cb17-6"><a href="selecting-region-of-interest.html#cb17-6" tabindex="-1"></a>    <span class="co"># if mask is applied to original, each coordinate is multiplied by 2</span></span>
<span id="cb17-7"><a href="selecting-region-of-interest.html#cb17-7" tabindex="-1"></a>    <span class="cf">if</span> on_original:</span>
<span id="cb17-8"><a href="selecting-region-of-interest.html#cb17-8" tabindex="-1"></a>        poly_verts <span class="op">=</span> [(<span class="dv">2</span> <span class="op">*</span> x, <span class="dv">2</span> <span class="op">*</span> y) <span class="cf">for</span> (x, y) <span class="kw">in</span> poly_verts]</span>
<span id="cb17-9"><a href="selecting-region-of-interest.html#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="selecting-region-of-interest.html#cb17-10" tabindex="-1"></a>    x, y <span class="op">=</span> np.meshgrid(np.arange(nx), np.arange(ny))</span>
<span id="cb17-11"><a href="selecting-region-of-interest.html#cb17-11" tabindex="-1"></a>    x, y <span class="op">=</span> x.flatten(), y.flatten()</span>
<span id="cb17-12"><a href="selecting-region-of-interest.html#cb17-12" tabindex="-1"></a>    points <span class="op">=</span> np.vstack((x, y)).T</span>
<span id="cb17-13"><a href="selecting-region-of-interest.html#cb17-13" tabindex="-1"></a>    roi_path <span class="op">=</span> MplPath(poly_verts)</span>
<span id="cb17-14"><a href="selecting-region-of-interest.html#cb17-14" tabindex="-1"></a>    mask <span class="op">=</span> roi_path.contains_points(points).reshape((ny, nx))</span>
<span id="cb17-15"><a href="selecting-region-of-interest.html#cb17-15" tabindex="-1"></a>    <span class="cf">return</span> mask</span></code></pre></div>
<p>After creating a region of interest, the user must click the <code>Confirm</code> button to proceed and apply the mask. These buttons are part of <code>matplotlib</code>’s <code>Button</code> module.</p>
<p>Creating one requires an event function, as well as button initialization as seen below for the <code>Confirm</code> button. The <code>confirm_roi</code> event is triggered when the button is clicked.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="selecting-region-of-interest.html#cb18-1" tabindex="-1"></a>confirm_ax <span class="op">=</span> plt.axes([<span class="fl">0.81</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.075</span>])</span>
<span id="cb18-2"><a href="selecting-region-of-interest.html#cb18-2" tabindex="-1"></a>confirm_button <span class="op">=</span> Button(confirm_ax, <span class="st">&#39;Confirm&#39;</span>)</span>
<span id="cb18-3"><a href="selecting-region-of-interest.html#cb18-3" tabindex="-1"></a>confirm_button.on_clicked(confirm_roi)</span>
<span id="cb18-4"><a href="selecting-region-of-interest.html#cb18-4" tabindex="-1"></a>confirm_button._button <span class="op">=</span> confirm_button</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="selecting-region-of-interest.html#cb19-1" tabindex="-1"></a><span class="kw">def</span> confirm_roi(event):</span>
<span id="cb19-2"><a href="selecting-region-of-interest.html#cb19-2" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb19-3"><a href="selecting-region-of-interest.html#cb19-3" tabindex="-1"></a><span class="co">    Callback event for confirm button</span></span>
<span id="cb19-4"><a href="selecting-region-of-interest.html#cb19-4" tabindex="-1"></a><span class="co">    If users select ROI and hit confirm, save the poly_verts and apply it to the rest of images</span></span>
<span id="cb19-5"><a href="selecting-region-of-interest.html#cb19-5" tabindex="-1"></a><span class="co">    Then, start showing next and previous buttons</span></span>
<span id="cb19-6"><a href="selecting-region-of-interest.html#cb19-6" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb19-7"><a href="selecting-region-of-interest.html#cb19-7" tabindex="-1"></a></span>
<span id="cb19-8"><a href="selecting-region-of-interest.html#cb19-8" tabindex="-1"></a>    <span class="co"># save current mask&#39;s poly_verts starting from start_img_ind index</span></span>
<span id="cb19-9"><a href="selecting-region-of-interest.html#cb19-9" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(start_img_ind, <span class="bu">len</span>(image_file_list)):</span>
<span id="cb19-10"><a href="selecting-region-of-interest.html#cb19-10" tabindex="-1"></a>        poly_verts_list[i] <span class="op">=</span> curr_poly_verts</span>
<span id="cb19-11"><a href="selecting-region-of-interest.html#cb19-11" tabindex="-1"></a></span>
<span id="cb19-12"><a href="selecting-region-of-interest.html#cb19-12" tabindex="-1"></a>    img_display_axis.set_title(<span class="st">&quot;Choose next or redraw ROI for </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(image_file_list[start_img_ind].date))</span>
<span id="cb19-13"><a href="selecting-region-of-interest.html#cb19-13" tabindex="-1"></a>    <span class="co"># button to show next and prev masked images</span></span>
<span id="cb19-14"><a href="selecting-region-of-interest.html#cb19-14" tabindex="-1"></a>    _ <span class="op">=</span> show_next_prev()</span></code></pre></div>
<p>We use Boolean algebra to apply the mask onto the image, rendering everything outside of the ROI black.</p>
<p>After the ROI is confirmed and mask is applied, users can click the <code>Previous</code> and <code>Next</code> buttons to view subsequent/prior images in the folder with the mask applied.</p>
<p>These are part of the callback function <code>Callback</code>, which makes sliding through a folder possible through indexing. By indexing, each image is drawn with its associated date in the figure title.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="selecting-region-of-interest.html#cb20-1" tabindex="-1"></a><span class="kw">def</span> <span class="bu">next</span>(<span class="va">self</span>, event):</span>
<span id="cb20-2"><a href="selecting-region-of-interest.html#cb20-2" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb20-3"><a href="selecting-region-of-interest.html#cb20-3" tabindex="-1"></a><span class="co">    :param event: event callback for matplotlib button</span></span>
<span id="cb20-4"><a href="selecting-region-of-interest.html#cb20-4" tabindex="-1"></a><span class="co">    Slide to the next image in folder and display it</span></span>
<span id="cb20-5"><a href="selecting-region-of-interest.html#cb20-5" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb20-6"><a href="selecting-region-of-interest.html#cb20-6" tabindex="-1"></a>    <span class="va">self</span>.index <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb20-7"><a href="selecting-region-of-interest.html#cb20-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.index_in_range():</span>
<span id="cb20-8"><a href="selecting-region-of-interest.html#cb20-8" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Reached End of Folder&quot;</span>)</span>
<span id="cb20-9"><a href="selecting-region-of-interest.html#cb20-9" tabindex="-1"></a>        <span class="va">self</span>.index <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb20-10"><a href="selecting-region-of-interest.html#cb20-10" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb20-11"><a href="selecting-region-of-interest.html#cb20-11" tabindex="-1"></a>    im <span class="op">=</span> <span class="va">self</span>.get_masked_img()</span>
<span id="cb20-12"><a href="selecting-region-of-interest.html#cb20-12" tabindex="-1"></a>    img_display.set_data(im)</span>
<span id="cb20-13"><a href="selecting-region-of-interest.html#cb20-13" tabindex="-1"></a>    img_display_axis.set_title(<span class="st">&quot;Click next or draw new ROI for Date: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(image_file_list[<span class="va">self</span>.index].get_date()))</span>
<span id="cb20-14"><a href="selecting-region-of-interest.html#cb20-14" tabindex="-1"></a>    plt.draw()</span>
<span id="cb20-15"><a href="selecting-region-of-interest.html#cb20-15" tabindex="-1"></a></span>
<span id="cb20-16"><a href="selecting-region-of-interest.html#cb20-16" tabindex="-1"></a><span class="kw">def</span> prev(<span class="va">self</span>, event):</span>
<span id="cb20-17"><a href="selecting-region-of-interest.html#cb20-17" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb20-18"><a href="selecting-region-of-interest.html#cb20-18" tabindex="-1"></a><span class="co">    :param event: event callback for matplotlib button</span></span>
<span id="cb20-19"><a href="selecting-region-of-interest.html#cb20-19" tabindex="-1"></a><span class="co">    Slide to the previous image in folder and display it</span></span>
<span id="cb20-20"><a href="selecting-region-of-interest.html#cb20-20" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb20-21"><a href="selecting-region-of-interest.html#cb20-21" tabindex="-1"></a>    <span class="va">self</span>.index <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb20-22"><a href="selecting-region-of-interest.html#cb20-22" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.index_in_range():</span>
<span id="cb20-23"><a href="selecting-region-of-interest.html#cb20-23" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Reached Start of Folder&quot;</span>)</span>
<span id="cb20-24"><a href="selecting-region-of-interest.html#cb20-24" tabindex="-1"></a>        <span class="va">self</span>.index <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb20-25"><a href="selecting-region-of-interest.html#cb20-25" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb20-26"><a href="selecting-region-of-interest.html#cb20-26" tabindex="-1"></a></span>
<span id="cb20-27"><a href="selecting-region-of-interest.html#cb20-27" tabindex="-1"></a>    im <span class="op">=</span> <span class="va">self</span>.get_masked_img()</span>
<span id="cb20-28"><a href="selecting-region-of-interest.html#cb20-28" tabindex="-1"></a>    img_display.set_data(im)</span>
<span id="cb20-29"><a href="selecting-region-of-interest.html#cb20-29" tabindex="-1"></a>    img_display_axis.set_title(<span class="st">&quot;Click next or draw new ROI for Date: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(image_file_list[<span class="va">self</span>.index].get_date()))</span>
<span id="cb20-30"><a href="selecting-region-of-interest.html#cb20-30" tabindex="-1"></a>    plt.draw()</span></code></pre></div>
<p>To redraw the ROI and apply it to the remaining images, the user must click the <code>Restart masking</code> button. The user can then create a new region of interest and click <code>Confirm</code> to proceed to apply the new mask. After creating a new ROI, the user has the option to either confirm or to redraw the ROI again.</p>
<p>The underlying dynamics of the <code>restart_masking</code> button can be seen here.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="selecting-region-of-interest.html#cb21-1" tabindex="-1"></a><span class="kw">def</span> restart_masking(event):</span>
<span id="cb21-2"><a href="selecting-region-of-interest.html#cb21-2" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-3"><a href="selecting-region-of-interest.html#cb21-3" tabindex="-1"></a><span class="co">    :param event: Callback event when user restarts masking</span></span>
<span id="cb21-4"><a href="selecting-region-of-interest.html#cb21-4" tabindex="-1"></a><span class="co">    Clears plot and begin a new ROI masking session</span></span>
<span id="cb21-5"><a href="selecting-region-of-interest.html#cb21-5" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb21-6"><a href="selecting-region-of-interest.html#cb21-6" tabindex="-1"></a>    <span class="kw">global</span> my_roi, confirm_button, restart_masking_button, img_display, img_display_axis, start_img_ind, curr_mask, curr_poly_verts</span>
<span id="cb21-7"><a href="selecting-region-of-interest.html#cb21-7" tabindex="-1"></a></span>
<span id="cb21-8"><a href="selecting-region-of-interest.html#cb21-8" tabindex="-1"></a>    <span class="co"># clear plot</span></span>
<span id="cb21-9"><a href="selecting-region-of-interest.html#cb21-9" tabindex="-1"></a>    plt.clf()</span>
<span id="cb21-10"><a href="selecting-region-of-interest.html#cb21-10" tabindex="-1"></a>    <span class="co"># create new plot</span></span>
<span id="cb21-11"><a href="selecting-region-of-interest.html#cb21-11" tabindex="-1"></a>    fg_2 <span class="op">=</span> plt.gcf()</span>
<span id="cb21-12"><a href="selecting-region-of-interest.html#cb21-12" tabindex="-1"></a>    fg_2.subplots_adjust(left<span class="op">=</span><span class="fl">0.3</span>, bottom<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb21-13"><a href="selecting-region-of-interest.html#cb21-13" tabindex="-1"></a>    fg_2.set_size_inches(w, h, forward<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-14"><a href="selecting-region-of-interest.html#cb21-14" tabindex="-1"></a></span>
<span id="cb21-15"><a href="selecting-region-of-interest.html#cb21-15" tabindex="-1"></a>    <span class="co"># change the content of image on curr axis</span></span>
<span id="cb21-16"><a href="selecting-region-of-interest.html#cb21-16" tabindex="-1"></a>    img_display_axis <span class="op">=</span> plt.gca()</span>
<span id="cb21-17"><a href="selecting-region-of-interest.html#cb21-17" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> callback.index_in_range():</span>
<span id="cb21-18"><a href="selecting-region-of-interest.html#cb21-18" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;OUT OF RANGE&quot;</span>)</span>
<span id="cb21-19"><a href="selecting-region-of-interest.html#cb21-19" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb21-20"><a href="selecting-region-of-interest.html#cb21-20" tabindex="-1"></a>    curr_ind <span class="op">=</span> callback.index</span>
<span id="cb21-21"><a href="selecting-region-of-interest.html#cb21-21" tabindex="-1"></a>    curr_obj <span class="op">=</span> image_file_list[curr_ind]</span>
<span id="cb21-22"><a href="selecting-region-of-interest.html#cb21-22" tabindex="-1"></a>    img_display_axis.set_title(<span class="st">&quot;Confirm ROI? Date: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(curr_obj.get_date()))</span>
<span id="cb21-23"><a href="selecting-region-of-interest.html#cb21-23" tabindex="-1"></a>    img_display <span class="op">=</span> img_display_axis.imshow(curr_obj.read_img_sliced())</span>
<span id="cb21-24"><a href="selecting-region-of-interest.html#cb21-24" tabindex="-1"></a>    <span class="co"># display new ROI pop up</span></span>
<span id="cb21-25"><a href="selecting-region-of-interest.html#cb21-25" tabindex="-1"></a>    my_roi <span class="op">=</span> RoiPoly(color<span class="op">=</span><span class="st">&#39;r&#39;</span>, close_fig<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-26"><a href="selecting-region-of-interest.html#cb21-26" tabindex="-1"></a></span>
<span id="cb21-27"><a href="selecting-region-of-interest.html#cb21-27" tabindex="-1"></a>    <span class="co"># wait until the user finishes selecting ROI</span></span>
<span id="cb21-28"><a href="selecting-region-of-interest.html#cb21-28" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> my_roi.finished_clicking:</span>
<span id="cb21-29"><a href="selecting-region-of-interest.html#cb21-29" tabindex="-1"></a>        plt.pause(<span class="fl">0.01</span>)</span>
<span id="cb21-30"><a href="selecting-region-of-interest.html#cb21-30" tabindex="-1"></a></span>
<span id="cb21-31"><a href="selecting-region-of-interest.html#cb21-31" tabindex="-1"></a>    <span class="co"># mask current image and display</span></span>
<span id="cb21-32"><a href="selecting-region-of-interest.html#cb21-32" tabindex="-1"></a>    cp <span class="op">=</span> curr_obj.read_img_sliced().copy()</span>
<span id="cb21-33"><a href="selecting-region-of-interest.html#cb21-33" tabindex="-1"></a>    curr_mask, curr_poly_verts <span class="op">=</span> my_roi.get_mask(cp)</span>
<span id="cb21-34"><a href="selecting-region-of-interest.html#cb21-34" tabindex="-1"></a>    cp <span class="op">=</span> apply_mask(cp, curr_mask)</span>
<span id="cb21-35"><a href="selecting-region-of-interest.html#cb21-35" tabindex="-1"></a>    start_img_ind <span class="op">=</span> curr_ind</span>
<span id="cb21-36"><a href="selecting-region-of-interest.html#cb21-36" tabindex="-1"></a>    img_display <span class="op">=</span> img_display_axis.imshow(cp)</span>
<span id="cb21-37"><a href="selecting-region-of-interest.html#cb21-37" tabindex="-1"></a></span>
<span id="cb21-38"><a href="selecting-region-of-interest.html#cb21-38" tabindex="-1"></a>    <span class="co"># Create a confirm mask button for new session</span></span>
<span id="cb21-39"><a href="selecting-region-of-interest.html#cb21-39" tabindex="-1"></a>    confirm_ax <span class="op">=</span> plt.axes([<span class="fl">0.81</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.075</span>])</span>
<span id="cb21-40"><a href="selecting-region-of-interest.html#cb21-40" tabindex="-1"></a>    confirm_button <span class="op">=</span> Button(confirm_ax, <span class="st">&#39;Confirm&#39;</span>)</span>
<span id="cb21-41"><a href="selecting-region-of-interest.html#cb21-41" tabindex="-1"></a>    confirm_button.on_clicked(confirm_roi)</span>
<span id="cb21-42"><a href="selecting-region-of-interest.html#cb21-42" tabindex="-1"></a>    confirm_button._button <span class="op">=</span> confirm_button</span>
<span id="cb21-43"><a href="selecting-region-of-interest.html#cb21-43" tabindex="-1"></a></span>
<span id="cb21-44"><a href="selecting-region-of-interest.html#cb21-44" tabindex="-1"></a>    <span class="co"># Create a restart mask button for new session</span></span>
<span id="cb21-45"><a href="selecting-region-of-interest.html#cb21-45" tabindex="-1"></a>    restart_masking_ax <span class="op">=</span> plt.axes([<span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.075</span>])</span>
<span id="cb21-46"><a href="selecting-region-of-interest.html#cb21-46" tabindex="-1"></a>    restart_masking_button <span class="op">=</span> Button(restart_masking_ax, <span class="st">&quot;Restart masking&quot;</span>)</span>
<span id="cb21-47"><a href="selecting-region-of-interest.html#cb21-47" tabindex="-1"></a>    restart_masking_button.on_clicked(restart_masking)</span>
<span id="cb21-48"><a href="selecting-region-of-interest.html#cb21-48" tabindex="-1"></a></span>
<span id="cb21-49"><a href="selecting-region-of-interest.html#cb21-49" tabindex="-1"></a>    plt.draw()</span></code></pre></div>
<p>Once masking has been complete, click the <code>Finish masking</code> button to close the figure. This button event also generates the output of the script. This event is slow and hefty, expect a long processing time.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="selecting-region-of-interest.html#cb22-1" tabindex="-1"></a><span class="kw">def</span> finish_masking(event):</span>
<span id="cb22-2"><a href="selecting-region-of-interest.html#cb22-2" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb22-3"><a href="selecting-region-of-interest.html#cb22-3" tabindex="-1"></a><span class="co">        :param event: Callback event for finish masking button</span></span>
<span id="cb22-4"><a href="selecting-region-of-interest.html#cb22-4" tabindex="-1"></a><span class="co">        save dataframe linking mask_id to actual mask  (mask_df)</span></span>
<span id="cb22-5"><a href="selecting-region-of-interest.html#cb22-5" tabindex="-1"></a><span class="co">        create water year folders</span></span>
<span id="cb22-6"><a href="selecting-region-of-interest.html#cb22-6" tabindex="-1"></a><span class="co">        save dataframe linking date to mask_id (date_mask_df)</span></span>
<span id="cb22-7"><a href="selecting-region-of-interest.html#cb22-7" tabindex="-1"></a><span class="co">        apply masks on original images and save them in their respective water year folders</span></span>
<span id="cb22-8"><a href="selecting-region-of-interest.html#cb22-8" tabindex="-1"></a><span class="co">        close plot</span></span>
<span id="cb22-9"><a href="selecting-region-of-interest.html#cb22-9" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb22-10"><a href="selecting-region-of-interest.html#cb22-10" tabindex="-1"></a>    <span class="kw">global</span> poly_verts_list</span>
<span id="cb22-11"><a href="selecting-region-of-interest.html#cb22-11" tabindex="-1"></a></span>
<span id="cb22-12"><a href="selecting-region-of-interest.html#cb22-12" tabindex="-1"></a>    <span class="co"># collect unique poly_verts and assign mask_ids to them</span></span>
<span id="cb22-13"><a href="selecting-region-of-interest.html#cb22-13" tabindex="-1"></a>    poly_verts_unique_list <span class="op">=</span> []</span>
<span id="cb22-14"><a href="selecting-region-of-interest.html#cb22-14" tabindex="-1"></a>    mask_id <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb22-15"><a href="selecting-region-of-interest.html#cb22-15" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(poly_verts_list)):</span>
<span id="cb22-16"><a href="selecting-region-of-interest.html#cb22-16" tabindex="-1"></a>        <span class="cf">if</span> mask_id <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">or</span> poly_verts_list[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">!=</span> poly_verts_list[i]:</span>
<span id="cb22-17"><a href="selecting-region-of-interest.html#cb22-17" tabindex="-1"></a>            mask_id <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb22-18"><a href="selecting-region-of-interest.html#cb22-18" tabindex="-1"></a>            poly_verts_unique_list.append(poly_verts_list[i])</span>
<span id="cb22-19"><a href="selecting-region-of-interest.html#cb22-19" tabindex="-1"></a>        <span class="co"># assign mask_ids to all ImageFile objects</span></span>
<span id="cb22-20"><a href="selecting-region-of-interest.html#cb22-20" tabindex="-1"></a>        image_file_list[i].mask_id <span class="op">=</span> mask_id</span>
<span id="cb22-21"><a href="selecting-region-of-interest.html#cb22-21" tabindex="-1"></a></span>
<span id="cb22-22"><a href="selecting-region-of-interest.html#cb22-22" tabindex="-1"></a>    <span class="co"># Save a mask_df data frame with columns mask_id-&gt; actual mask(poly_verts) and save it</span></span>
<span id="cb22-23"><a href="selecting-region-of-interest.html#cb22-23" tabindex="-1"></a>    mask_df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(<span class="bu">zip</span>(poly_verts_unique_list)), columns<span class="op">=</span>[<span class="st">&quot;poly_verts&quot;</span>])</span>
<span id="cb22-24"><a href="selecting-region-of-interest.html#cb22-24" tabindex="-1"></a>    mask_df.index.name <span class="op">=</span> <span class="st">&quot;mask_id&quot;</span></span>
<span id="cb22-25"><a href="selecting-region-of-interest.html#cb22-25" tabindex="-1"></a>    mask_df_dst <span class="op">=</span> folder_path <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> <span class="st">&quot;mask_df.csv&quot;</span></span>
<span id="cb22-26"><a href="selecting-region-of-interest.html#cb22-26" tabindex="-1"></a>    mask_df.to_csv(mask_df_dst)</span>
<span id="cb22-27"><a href="selecting-region-of-interest.html#cb22-27" tabindex="-1"></a>    <span class="co"># print(mask_df.head())</span></span>
<span id="cb22-28"><a href="selecting-region-of-interest.html#cb22-28" tabindex="-1"></a></span>
<span id="cb22-29"><a href="selecting-region-of-interest.html#cb22-29" tabindex="-1"></a>    <span class="co"># collect all information from ImageFile Objects</span></span>
<span id="cb22-30"><a href="selecting-region-of-interest.html#cb22-30" tabindex="-1"></a>    image_file_info <span class="op">=</span> pd.DataFrame(</span>
<span id="cb22-31"><a href="selecting-region-of-interest.html#cb22-31" tabindex="-1"></a>        [(i.date, i.mask_id, i.path, i.get_water_year(), ind, poly_verts_list[ind]) <span class="cf">for</span> ind, i <span class="kw">in</span></span>
<span id="cb22-32"><a href="selecting-region-of-interest.html#cb22-32" tabindex="-1"></a>         <span class="bu">enumerate</span>(image_file_list)],</span>
<span id="cb22-33"><a href="selecting-region-of-interest.html#cb22-33" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">&quot;Date&quot;</span>, <span class="st">&quot;mask_id&quot;</span>, <span class="st">&quot;file_path&quot;</span>, <span class="st">&quot;WY&quot;</span>, <span class="st">&quot;list_index&quot;</span>, <span class="st">&quot;poly_verts&quot;</span>])</span>
<span id="cb22-34"><a href="selecting-region-of-interest.html#cb22-34" tabindex="-1"></a>    image_file_info.set_index(<span class="st">&quot;WY&quot;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-35"><a href="selecting-region-of-interest.html#cb22-35" tabindex="-1"></a>    <span class="co"># print(image_file_info.head())</span></span>
<span id="cb22-36"><a href="selecting-region-of-interest.html#cb22-36" tabindex="-1"></a></span>
<span id="cb22-37"><a href="selecting-region-of-interest.html#cb22-37" tabindex="-1"></a>    <span class="co"># list of water years</span></span>
<span id="cb22-38"><a href="selecting-region-of-interest.html#cb22-38" tabindex="-1"></a>    list_wy <span class="op">=</span> <span class="bu">list</span>(image_file_info.index.unique())</span>
<span id="cb22-39"><a href="selecting-region-of-interest.html#cb22-39" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;STARTED SAVING&quot;</span>)</span>
<span id="cb22-40"><a href="selecting-region-of-interest.html#cb22-40" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;This takes about 1 second per an image file&quot;</span>)</span>
<span id="cb22-41"><a href="selecting-region-of-interest.html#cb22-41" tabindex="-1"></a></span>
<span id="cb22-42"><a href="selecting-region-of-interest.html#cb22-42" tabindex="-1"></a>    <span class="cf">for</span> water_year <span class="kw">in</span> list_wy:</span>
<span id="cb22-43"><a href="selecting-region-of-interest.html#cb22-43" tabindex="-1"></a>        <span class="co"># Create folders for each water year</span></span>
<span id="cb22-44"><a href="selecting-region-of-interest.html#cb22-44" tabindex="-1"></a>        wy_dest <span class="op">=</span> folder_path <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> <span class="st">&quot;WY&quot;</span> <span class="op">+</span> <span class="bu">str</span>(water_year)</span>
<span id="cb22-45"><a href="selecting-region-of-interest.html#cb22-45" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(wy_dest):</span>
<span id="cb22-46"><a href="selecting-region-of-interest.html#cb22-46" tabindex="-1"></a>            os.mkdir(wy_dest)</span>
<span id="cb22-47"><a href="selecting-region-of-interest.html#cb22-47" tabindex="-1"></a>        <span class="co"># loop through index of image_file_objects and save original images with their mask</span></span>
<span id="cb22-48"><a href="selecting-region-of-interest.html#cb22-48" tabindex="-1"></a>        df <span class="op">=</span> image_file_info[image_file_info.index <span class="op">==</span> water_year]</span>
<span id="cb22-49"><a href="selecting-region-of-interest.html#cb22-49" tabindex="-1"></a></span>
<span id="cb22-50"><a href="selecting-region-of-interest.html#cb22-50" tabindex="-1"></a>        <span class="co"># save a date_mask dataframe with columns date-&gt; mask_id -&gt; file name</span></span>
<span id="cb22-51"><a href="selecting-region-of-interest.html#cb22-51" tabindex="-1"></a>        date_mask_df <span class="op">=</span> df.reset_index()[[<span class="st">&quot;Date&quot;</span>, <span class="st">&quot;mask_id&quot;</span>]].set_index(<span class="st">&quot;Date&quot;</span>)</span>
<span id="cb22-52"><a href="selecting-region-of-interest.html#cb22-52" tabindex="-1"></a>        date_mask_df.to_csv(wy_dest <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> <span class="st">&quot;date_mask.csv&quot;</span>)</span>
<span id="cb22-53"><a href="selecting-region-of-interest.html#cb22-53" tabindex="-1"></a></span>
<span id="cb22-54"><a href="selecting-region-of-interest.html#cb22-54" tabindex="-1"></a>        <span class="co"># mask images within a selected water_year</span></span>
<span id="cb22-55"><a href="selecting-region-of-interest.html#cb22-55" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb22-56"><a href="selecting-region-of-interest.html#cb22-56" tabindex="-1"></a>            folder_index <span class="op">=</span> row[<span class="st">&quot;list_index&quot;</span>]</span>
<span id="cb22-57"><a href="selecting-region-of-interest.html#cb22-57" tabindex="-1"></a>            curr_file_path <span class="op">=</span> row[<span class="st">&quot;file_path&quot;</span>]</span>
<span id="cb22-58"><a href="selecting-region-of-interest.html#cb22-58" tabindex="-1"></a></span>
<span id="cb22-59"><a href="selecting-region-of-interest.html#cb22-59" tabindex="-1"></a>            <span class="co"># save masked image to WY destination</span></span>
<span id="cb22-60"><a href="selecting-region-of-interest.html#cb22-60" tabindex="-1"></a>            curr_obj <span class="op">=</span> image_file_list[folder_index]</span>
<span id="cb22-61"><a href="selecting-region-of-interest.html#cb22-61" tabindex="-1"></a>            curr_file_name <span class="op">=</span> curr_obj.image_name</span>
<span id="cb22-62"><a href="selecting-region-of-interest.html#cb22-62" tabindex="-1"></a>            curr_original_image <span class="op">=</span> curr_obj.read_img_orig().copy()</span>
<span id="cb22-63"><a href="selecting-region-of-interest.html#cb22-63" tabindex="-1"></a>            curr_original_mask <span class="op">=</span> get_mask_poly_verts(curr_original_image, poly_verts_list[folder_index],</span>
<span id="cb22-64"><a href="selecting-region-of-interest.html#cb22-64" tabindex="-1"></a>                                                     on_original<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-65"><a href="selecting-region-of-interest.html#cb22-65" tabindex="-1"></a>            curr_original_image <span class="op">=</span> apply_mask(curr_original_image, curr_original_mask)</span>
<span id="cb22-66"><a href="selecting-region-of-interest.html#cb22-66" tabindex="-1"></a>            curr_img_save_dest <span class="op">=</span> wy_dest <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> curr_file_name</span>
<span id="cb22-67"><a href="selecting-region-of-interest.html#cb22-67" tabindex="-1"></a></span>
<span id="cb22-68"><a href="selecting-region-of-interest.html#cb22-68" tabindex="-1"></a>            <span class="co"># save curr_original_image</span></span>
<span id="cb22-69"><a href="selecting-region-of-interest.html#cb22-69" tabindex="-1"></a>            Image.fromarray(np.array(curr_original_image)).save(curr_img_save_dest)</span>
<span id="cb22-70"><a href="selecting-region-of-interest.html#cb22-70" tabindex="-1"></a></span>
<span id="cb22-71"><a href="selecting-region-of-interest.html#cb22-71" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;FINISHED SAVING&quot;</span>)</span>
<span id="cb22-72"><a href="selecting-region-of-interest.html#cb22-72" tabindex="-1"></a>    plt.close()</span></code></pre></div>
</div>
</div>
<div id="documentation" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Documentation<a href="selecting-region-of-interest.html#documentation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For complete documentation and explanations behind the code, see the script itself.
Below is a list of all functions within the script and a brief description of their purpose.</p>
<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>init</td>
<td>Constructor</td>
</tr>
<tr class="even">
<td>get_date</td>
<td>Extracts date pattern (MM/DD/YY) from file name (eg. Hbwtr_w3_20200315_115918.JPG)</td>
</tr>
<tr class="odd">
<td>get_water_year</td>
<td>Extracts water year from dates (a water year runs from October 1st of the year prior to September 30th of the current year)</td>
</tr>
<tr class="even">
<td>read_img_orig</td>
<td>Reads image path and returns original image (as np.array)</td>
</tr>
<tr class="odd">
<td>read_img_sliced</td>
<td>Reads image path and returns sliced image (np.array) for faster display</td>
</tr>
<tr class="even">
<td>next</td>
<td>Slides to next image in image folder and displays it</td>
</tr>
<tr class="odd">
<td>prev</td>
<td>Slides to the previous image in folder and displays it</td>
</tr>
<tr class="even">
<td>index_in_range</td>
<td>Checks if the current index is within the range of the image_file_list</td>
</tr>
<tr class="odd">
<td>get_masked_img</td>
<td>Apply mask from poly_verts_list and return masked image</td>
</tr>
<tr class="even">
<td>start_roi_selection</td>
<td>Allows user to select and confirm ROI</td>
</tr>
<tr class="odd">
<td>show_first_image</td>
<td>Displays the first image</td>
</tr>
<tr class="even">
<td>confirm_ROI</td>
<td>If ROI is confirmed, save poly_verts and apply to the remaining images</td>
</tr>
<tr class="odd">
<td>show_next_prev</td>
<td>Creates next, previous, and finish buttons</td>
</tr>
<tr class="even">
<td>restart_masking</td>
<td>Clears plot and begin a new ROI masking session</td>
</tr>
<tr class="odd">
<td>finish_masking</td>
<td>Saves dataframe linking mask_id to actual mask (mask_df), creates water year folders, saves dataframe linking date to mask_id (date_mask_df), applies masks on original images and saves them in their respective water year folders, then closes plot</td>
</tr>
<tr class="even">
<td>apply_mask</td>
<td>Applies mask to image</td>
</tr>
<tr class="odd">
<td>get_mask_poly_verts</td>
<td>Returns coordinates for image mask that can be applied to image</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="4">
<li id="fn4"><p>Information on matplotlib backends can be found at <a href="https://matplotlib.org/stable/users/explain/backends.html" class="uri">https://matplotlib.org/stable/users/explain/backends.html</a><a href="selecting-region-of-interest.html#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>Our version of RoiPoly is derived from jdoepfert’s roipoly.py, whose module can be found on at <a href="https://github.com/jdoepfert/roipoly.py" class="uri">https://github.com/jdoepfert/roipoly.py</a><a href="selecting-region-of-interest.html#fnref5" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="rename-raw-images.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="classifying-image-attributes-with-via.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="book_assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="book_assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="book_assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/henrysun9074/hbwater_cameratrap_pheno/edit/master/02-roi.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/henrysun9074/hbwater_cameratrap_pheno/blob/master/02-roi.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
